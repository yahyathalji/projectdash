<!doctype html>
<html class="no-js" lang="en" dir="ltr">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>::Fantasize:: Dashboard</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon"> <!-- Favicon-->

    <!-- Plugin CSS files -->
    <link rel="stylesheet" href="assets/plugin/datatables/responsive.dataTables.min.css">
    <link rel="stylesheet" href="assets/plugin/datatables/dataTables.bootstrap5.min.css">

    <!-- Project CSS file -->
    <link rel="stylesheet" href="assets/css/ebazar.style.min.css">
</head>
<body>
    <div id="ebazar-layout" class="theme-blue">
        
        <!-- Sidebar -->
        <div id="sidebar"></div>

        <!-- Main Body Area -->
        <div class="main px-lg-4 px-md-4">

            <!-- Body: Header -->
            <div id="header"></div>

            <!-- Body: Content -->
            <div class="body d-flex py-3">
                <div class="container-xxl">
                    <!-- Statistics Cards -->
                    <div class="row g-3">
                        <div class="col-lg-12 col-md-12">
                            <div class="tab-content mt-1">
                                <div class="tab-pane fade show active" id="summery-today">
                                    <div class="row g-1 g-sm-3 mb-3 row-deck">
                                        <!-- Customers Card -->
                                        <div class="col-xl-4 col-lg-4 col-md-4 col-sm-6">
                                            <div class="card">
                                                <div class="card-body py-xl-4 py-3 d-flex flex-wrap align-items-center justify-content-between">
                                                    <div class="left-info">
                                                        <span class="text-muted">Customers</span>
                                                        <div><span class="fs-6 fw-bold me-2" id="total_users">0</span></div>
                                                    </div>
                                                    <div class="right-icon">
                                                        <i class="icofont-student-alt fs-3 color-light-orange"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Orders Card -->
                                        <div class="col-xl-4 col-lg-4 col-md-4 col-sm-6">
                                            <div class="card">
                                                <div class="card-body py-xl-4 py-3 d-flex flex-wrap align-items-center justify-content-between">
                                                    <div class="left-info">
                                                        <span class="text-muted">Orders</span>
                                                        <div><span class="fs-6 fw-bold me-2" id="total_orders">0</span></div>
                                                    </div>
                                                    <div class="right-icon">
                                                        <i class="icofont-shopping-cart fs-3 color-lavender-purple"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Avg Sale Card -->
                                        <div class="col-xl-4 col-lg-4 col-md-4 col-sm-6">
                                            <div class="card">
                                                <div class="card-body py-xl-4 py-3 d-flex flex-wrap align-items-center justify-content-between">
                                                    <div class="left-info">
                                                        <span class="text-muted">Avg Sale</span>
                                                        <div><span class="fs-6 fw-bold me-2" id="avg_price">$0.00</span></div>
                                                    </div>
                                                    <div class="right-icon">
                                                        <i class="icofont-sale-discount fs-3 color-santa-fe"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Avg Item Sale Card -->
                                        <div class="col-xl-4 col-lg-4 col-md-4 col-sm-6">
                                            <div class="card">
                                                <div class="card-body py-xl-4 py-3 d-flex flex-wrap align-items-center justify-content-between">
                                                    <div class="left-info">
                                                        <span class="text-muted">Avg Item Sale</span>
                                                        <div><span class="fs-6 fw-bold me-2" id="AverageSale">$0.00</span></div>
                                                    </div>
                                                    <div class="right-icon">
                                                        <i class="icofont-calculator-alt-2 fs-3 color-danger"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Total Sale Card -->
                                        <div class="col-xl-4 col-lg-4 col-md-4 col-sm-6">
                                            <div class="card">
                                                <div class="card-body py-xl-4 py-3 d-flex flex-wrap align-items-center justify-content-between">
                                                    <div class="left-info">
                                                        <span class="text-muted">Total Sale</span>
                                                        <div><span class="fs-6 fw-bold me-2" id="TotalSale">$0.00</span></div>
                                                    </div>
                                                    <div class="right-icon">
                                                        <i class="icofont-calculator-alt-1 fs-3 color-lightblue"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Active Users Card -->
                                        <div class="col-xl-4 col-lg-4 col-md-4 col-sm-6">
                                            <div class="card">
                                                <div class="card-body py-xl-4 py-3 d-flex flex-wrap align-items-center justify-content-between">
                                                    <div class="left-info">
                                                        <span class="text-muted">Active Users</span>
                                                        <div><span class="fs-6 fw-bold me-2" id="active_users">0</span></div>
                                                    </div>
                                                    <div class="right-icon">
                                                        <i class="icofont-users-social fs-3 color-light-success"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Total Categories Card -->
                                        <div class="col-xl-4 col-lg-4 col-md-4 col-sm-6">
                                            <div class="card">
                                                <div class="card-body py-xl-4 py-3 d-flex flex-wrap align-items-center justify-content-between">
                                                    <div class="left-info">
                                                        <span class="text-muted">Total Categories</span>
                                                        <div><span class="fs-6 fw-bold me-2" id="total_categories">0</span></div>
                                                    </div>
                                                    <div class="right-icon">
                                                        <i class="icofont-chart-flow-2 fs-3 color-light-orange"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Total Subcategories Card -->
                                        <div class="col-xl-4 col-lg-4 col-md-4 col-sm-6">
                                            <div class="card">
                                                <div class="card-body py-xl-4 py-3 d-flex flex-wrap align-items-center justify-content-between">
                                                    <div class="left-info">
                                                        <span class="text-muted">Total Subcategories</span>
                                                        <div><span class="fs-6 fw-bold me-2" id="total_subcategories">0</span></div>
                                                    </div>
                                                    <div class="right-icon">
                                                        <i class="icofont-chart-flow-1 fs-3" style="color: #FFB6C1;"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Total Products Card -->
                                        <div class="col-xl-4 col-lg-4 col-md-4 col-sm-6">
                                            <div class="card">
                                                <div class="card-body py-xl-4 py-3 d-flex flex-wrap align-items-center justify-content-between">
                                                    <div class="left-info">
                                                        <span class="text-muted">Total Products</span>
                                                        <div><span class="fs-6 fw-bold me-2" id="total_products">0</span></div>
                                                    </div>
                                                    <div class="right-icon">
                                                        <i class="icofont-bag fs-3 color-light-orange"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Total Packages Card -->
                                        <div class="col-xl-4 col-lg-4 col-md-4 col-sm-6">
                                            <div class="card">
                                                <div class="card-body py-xl-4 py-3 d-flex flex-wrap align-items-center justify-content-between">
                                                    <div class="left-info">
                                                        <span class="text-muted">Total Packages</span>
                                                        <div><span class="fs-6 fw-bold me-2" id="total_packages">0</span></div>
                                                    </div>
                                                    <div class="right-icon">
                                                        <i class="icofont-package fs-3" style="color: #FF6666;"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Total Active Offers Card -->
                                        <div class="col-xl-4 col-lg-4 col-md-4 col-sm-6">
                                            <div class="card">
                                                <div class="card-body py-xl-4 py-3 d-flex flex-wrap align-items-center justify-content-between">
                                                    <div class="left-info">
                                                        <span class="text-muted">Total Active Offers</span>
                                                        <div><span class="fs-6 fw-bold me-2" id="total_active_offers">0</span></div>
                                                    </div>
                                                    <div class="right-icon">
                                                        <i class="icofont-wink-smile fs-3" style="color: green;"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Avg Review Rating Card -->
                                        <div class="col-xl-4 col-lg-4 col-md-4 col-sm-6">
                                            <div class="card">
                                                <div class="card-body py-xl-4 py-3 d-flex flex-wrap align-items-center justify-content-between">
                                                    <div class="left-info">
                                                        <span class="text-muted">Avg Review Rating</span>
                                                        <div><span class="fs-6 fw-bold me-2" id="calculateGlobalAverageRating">0</span></div>
                                                    </div>
                                                    <div class="right-icon">
                                                        <i class="icofont-star fs-3 color-lightyellow"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div> <!-- Row end -->
                                </div>
                            </div>
                        </div><!-- Row end  -->

                        <!-- Avg Expense Costs and Chart -->
                        <div class="row g-3 mb-3" style="margin: 0.5%;">
                            <div class="col-lg-8 col-md-12">
                                <div class="card">
                                    <div class="card-header py-3 d-flex justify-content-between align-items-center bg-transparent border-bottom-0">
                                        <h6 class="m-0 fw-bold">Avg Expense Costs</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="h2 mb-0" id="avgCosts">$0.00</div>
                                        <span class="text-muted small">Avg Expense Costs All Month</span>
                                        <div id="apex-expense"></div>  
                                    </div>
                                </div>
                            </div>
                        </div><!-- Row end  -->

                        <!-- Recent Orders Table -->
                        <div class="row g-3 mb-3" style="margin: 0.5%;"> 
                            <div class="col-md-12">
                                <div class="card"> 
                                    <div class="card-body"> 
                                        <h6 class="m-0 fw-bold">Recent Orders</h6>
                                        <table id="myDataTable" class="table table-hover align-middle mb-0" style="width: 100%;">  
                                            <thead>
                                                <tr>
                                                    <th>Order-Id</th>
                                                    <th>Customer Name</th>
                                                    <th>Price</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Dynamic Content -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- Row end  -->

                        <!-- Top Products Table -->
                        <div class="row g-3 mb-3" style="margin: 0.5%;">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="m-0 fw-bold">Top Products</h6>
                                        <table id="topProductsTable" class="table table-hover align-middle mb-0" style="width: 100%;">
                                            <thead>
                                                <tr>
                                                    <th>Product Name</th>
                                                    <th>Total Quantity</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Dynamic Content -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- Row end -->

                    </div>
                </div>
            
                <!-- Modal Custom Settings-->
                <div id="modal"></div>
                
            </div>
        </div>    <script src="assets/js/common.js"></script>


        <!-- Load Components -->
        <script>
            function loadComponent(selector, url) {
                fetch(url)
                    .then(response => response.text())
                    .then(data => {
                        document.querySelector(selector).innerHTML = data;
                    })
                    .catch(error => {
                        console.error(`Error loading ${url}:`, error);
                    });
            }

            loadComponent('#sidebar', 'sidebar.html');
            loadComponent('#header', 'header.html');
            loadComponent('#modal', 'modal.html');
        </script>

        <!-- Jquery Core Js -->
        <script src="assets/bundles/libscripts.bundle.js"></script>

        <!-- Plugin Js -->
        <script src="assets/bundles/apexcharts.bundle.js"></script>
        <script src="assets/bundles/dataTables.bundle.js"></script>  

        <!-- Jquery Page Js -->
        <script src="../js/template.js"></script>
        <script src="../js/page/index.js"></script>
        <!-- Ensure that the custom JS is loaded after all dependencies -->
        <script src="assets/js/indexDashboard.js"></script>
        <script>
        class UserProfileManager {
            constructor() {
                this.authToken = sessionStorage.getItem('authToken');
                this.defaultImage = 'assets/images/profile_av.svg';
                this.apiBaseUrl = 'http://localhost:5000'; // Update this if needed
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                const signoutBtn = document.getElementById('signoutBtn');
                if (signoutBtn) {
                    signoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.handleSignout();
                    });
                } else {
                    console.warn('Signout button not found');
                }
            }

            async initialize() {
                console.log('Initializing UserProfileManager');
                if (!this.authToken) {
                    console.log('No authToken found, redirecting to signin');
                    window.location.href = 'auth-signin.html';
                    return;
                }

                try {
                    const userData = this.parseJwt(this.authToken);
                    this.updateProfileText(userData);
                    console.log('User data:', userData);
                    await this.loadProfileImage(userData.userProfilePicture);
                    await this.loadComponents();
                    console.log('UserProfileManager initialized successfully');
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.setDefaultProfileValues();
                }
            }

            /**
             * Parses a JWT token and returns the payload.
             * @param {string} token - The JWT token.
             * @returns {Object} The payload of the token.
             */
            parseJwt(token) {
                try {
                    const tokenParts = token.split('.');
                    if (tokenParts.length !== 3) {
                        throw new Error('Invalid JWT token structure');
                    }
                    const payload = JSON.parse(atob(tokenParts[1]));
                    if (!payload || !payload.payload) {
                        throw new Error('Invalid JWT payload');
                    }
                    return payload.payload;
                } catch (error) {
                    console.error('Error parsing JWT token:', error);
                    throw error;
                }
            }

            async loadComponents() {
                try {
                    const sidebarResponse = await fetch('sidebar.html');

                    if (!sidebarResponse.ok) {
                        throw new Error('Failed to load sidebar');
                    }

                    const sidebarContent = await sidebarResponse.text();
                    const sidebarElement = document.getElementById('sidebar');
                    if (sidebarElement) {
                        sidebarElement.innerHTML = sidebarContent;
                    } else {
                        console.warn('Sidebar element not found in HTML');
                    }

                    // Initialize any sidebar-specific scripts
                    if (typeof initSidebar === 'function') {
                        initSidebar();
                    }
                } catch (error) {
                    console.error('Error loading components:', error);
                    // Optionally, handle the error further or rethrow
                }
            }

            /**
             * Loads the user's profile image.
             * @param {Object} profilePicture - The user's profile picture information.
             */
            async loadProfileImage(profilePicture) {
                if (!profilePicture || !profilePicture.filePath) {
                    console.log('No profile picture information available. Using default image.');
                    this.setDefaultProfileImages();
                    return;
                }

                // Normalize filePath to use forward slashes
                const normalizedFilePath = profilePicture.filePath.replace(/\\/g, '/');

                // Construct the full URL for the profile image
                // Assuming that the API serves static files from the root
                const profileImageUrl = `${this.apiBaseUrl}/${normalizedFilePath}`;

                console.log(`Loading profile image from: ${profileImageUrl}`);

                const imageElements = ['profileImage', 'profileImageSmall'];

                imageElements.forEach(elementId => {
                    const imgElement = document.getElementById(elementId);
                    if (imgElement) {
                        imgElement.onerror = () => {
                            console.warn(`Failed to load image: ${profileImageUrl}. Using default image.`);
                            imgElement.src = this.defaultImage;
                            imgElement.onerror = null; // Prevent infinite loop if default image also fails
                        };
                        imgElement.src = profileImageUrl;
                    } else {
                        console.warn(`Image element with id ${elementId} not found`);
                    }
                });
            }

            /**
             * Updates the profile text elements with user data.
             * @param {Object} userData - The user data extracted from the JWT payload.
             */
            updateProfileText(userData) {
                const profileUserName = document.getElementById('profileUserName');
                const profileUserNameSmall = document.getElementById('profileUserNameSmall');
                const profileEmail = document.getElementById('profileEmail');
                const profileRole = document.getElementById('profileRole');

                if (profileUserName) {
                    profileUserName.textContent = userData.userName || 'User';
                }

                if (profileUserNameSmall) {
                    profileUserNameSmall.textContent = userData.userName || 'User';
                }

                if (profileEmail) {
                    profileEmail.textContent = userData.email || 'user@example.com';
                }

                if (profileRole) {
                    profileRole.textContent = `${userData.role || 'User'} Profile`;
                }
            }

            /**
             * Sets default profile values when user data is unavailable.
             */
            setDefaultProfileValues() {
                const defaultValues = {
                    userName: 'User',
                    email: 'user@example.com',
                    role: 'User'
                };

                this.updateProfileText(defaultValues);
                this.setDefaultProfileImages();
            }

            /**
             * Sets the profile images to the default image.
             */
            setDefaultProfileImages() {
                const imageElements = ['profileImage', 'profileImageSmall'];
                imageElements.forEach(elementId => {
                    const imgElement = document.getElementById(elementId);
                    if (imgElement) {
                        imgElement.src = this.defaultImage;
                    } else {
                        console.warn(`Image element with id ${elementId} not found`);
                    }
                });
            }

            /**
             * Handles the signout process by clearing the auth token and redirecting to the signin page.
             */
            handleSignout() {
                sessionStorage.removeItem('authToken');
                window.location.href = 'auth-signin.html';
            }
        }

        // Initialize when the document is ready
        document.addEventListener('DOMContentLoaded', () => {
            const userProfileManager = new UserProfileManager();
            userProfileManager.initialize().catch(error => {
                console.error('Failed to initialize user profile:', error);
            });
        });

        // Optional: Remove or implement global AJAX error handling if needed
      
        // If using jQuery, use jQuery's global AJAX error handler
        $(document).ajaxError(function(event, jqXHR, ajaxSettings, thrownError) {
            if (jqXHR.status === 401 || jqXHR.status === 403) {
                alert('Session expired. Please sign in again.');
                window.location.href = 'auth-signin.html';
            }
        });
    
    </script>
    </body>

</html>
