<!DOCTYPE html>
<html class="no-js" lang="en" dir="ltr">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>::Fantasize:: Product Edit</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <!-- Favicon-->

    <!-- Plugin CSS files -->
    <link rel="stylesheet" href="assets/plugin/multi-select/css/multi-select.css" />
    <!-- Multi Select Css -->
    <link rel="stylesheet" href="assets/plugin/bootstrap-tagsinput/bootstrap-tagsinput.css" />
    <!-- Bootstrap Tagsinput Css -->
    <link rel="stylesheet" href="assets/plugin/dropify/dist/css/dropify.min.css" />
    <!-- Dropify Css -->
    <link rel="stylesheet" href="assets/plugin/datatables/responsive.dataTables.min.css" />
    <!-- Datatable Css -->
    <link rel="stylesheet" href="assets/plugin/datatables/dataTables.bootstrap5.min.css" />
    <!-- Datatable Css -->

    <!-- Project CSS file -->
    <link rel="stylesheet" href="assets/css/ebazar.style.min.css" />
    <style>
        .material-item {
            margin-bottom: 10px;
        }
        .material-item .remove-material-btn {
            margin-top: 25px;
        }
        .resource-container {
            position: relative;
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .resource-container img,
        .resource-container video {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .resource-container button {
            position: absolute;
            top: -5px;
            right: -5px;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="ebazar-layout" class="theme-blue">
        <!-- Sidebar -->
        <div id="sidebar"></div>

        <!-- Main Body Area -->
        <div class="main px-lg-4 px-md-4">
            <!-- Header -->
            <div id="header"></div>

            <!-- Body -->
            <form id="EditProductForm" enctype="multipart/form-data">
                <div class="body d-flex py-3">
                    <div class="container-xxl">
                        <!-- Header Row -->
                        <div class="row align-items-center">
                            <div class="border-0 mb-4">
                                <div class="card-header py-3 no-bg bg-transparent d-flex align-items-center px-0 justify-content-between border-bottom flex-wrap">
                                    <h3 class="fw-bold mb-0">Products Edit</h3>
                                    <div id="responseMessage"></div>
                                    <button type="submit" class="btn btn-primary btn-set-task w-sm-100 py-2 px-5 text-uppercase">
                                        Save
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Row end  -->

                        <div class="row g-3 mb-3">
                            <!-- Customization Sidebar -->
                            <div class="col-xl-4 col-lg-4">
                                <div class="sticky-lg-top">
                                    <div class="card mb-3">
                                        <div class="card-header py-3 d-flex justify-content-between align-items-center bg-transparent border-bottom-0">
                                            <h6 class="m-0 fw-bold">Customization</h6>
                                            <a href="Assign-Product.html" class="btn btn-outline-secondary">
                                                <i class="icofont-edit text-success" data-bs-toggle="modal" data-bs-target="#expadd"></i>
                                            </a>
                                        </div>
                                    </div>

                                    <!-- Customizations Display Container -->
                                    <div class="card mb-3">
                                        <div class="card-header py-3 d-flex justify-content-between align-items-center bg-transparent border-bottom-0">
                                            <h6 class="mb-0 fw-bold">Existing Customizations</h6>
                                        </div>
                                        <div class="card-body" id="customizationContainer">
                                            <!-- Customizations will be dynamically added here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Main Form Area -->
                            <div class="col-xl-8 col-lg-8">
                                <!-- Basic Information Card -->
                                <div class="card mb-3">
                                    <div class="card-header py-3 d-flex justify-content-between bg-transparent border-bottom-0">
                                        <h6 class="mb-0 fw-bold">Basic Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3 align-items-center">
                                            <!-- Product Name -->
                                            <div class="col-md-6">
                                                <label class="form-label">Name</label>
                                                <input type="text" id="productName" class="form-control" placeholder="Enter Product Name" required />
                                            </div>

                                            <!-- Price -->
                                            <div class="col-md-6">
                                                <label class="form-label">Price</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" id="price" class="form-control" placeholder="Enter Price" min="0" step="0.01" required />
                                                </div>
                                            </div>

                                            <!-- Quantity -->
                                            <div class="col-md-6">
                                                <label class="form-label">Quantity</label>
                                                <input type="number" id="quantity" class="form-control" placeholder="Enter Quantity" min="0" required />
                                            </div>

                                            <!-- Product Description -->
                                            <div class="col-md-12">
                                                <label class="form-label">Product Description</label>
                                                <textarea class="form-control" id="description" rows="4" placeholder="Enter Product Description Here" required></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Brand Selection Card -->
                                <div class="card mb-3">
                                    <div class="card-header py-3 d-flex justify-content-between bg-transparent border-bottom-0">
                                        <h6 class="mb-0 fw-bold">Select a Brand</h6>
                                    </div>
                                    <div class="card-body">
                                        <select id="brandSelect" class="ms w-100" style="font-size: 18px; padding: 10px" required>
                                            <option value="" disabled selected>Select a Brand</option>
                                            <!-- Make sure these values are BrandID from your brand fetch logic -->
                                            <option value="1">Nike</option>
                                            <option value="2">Chanel</option>
                                            <option value="3">Prada</option>
                                            <option value="4">Lacoste</option>
                                            <option value="5">Balmain</option>
                                            <option value="6">Gucci</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Material Assignment Section -->
                                <div class="card mb-3" id="materialsAssignmentSection">
                                    <div class="card-header py-3 d-flex justify-content-between bg-transparent border-bottom-0">
                                        <h6 class="mb-0 fw-bold">Assign Materials</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="materialsContainer"></div>
                                        <button type="button" class="btn btn-secondary" id="addMaterialBtn">
                                            Add Another Material
                                        </button>
                                        <button type="button" class="btn btn-primary" id="updateMaterialsBtn">
                                            Update Materials
                                        </button>
                                        <div id="materialsResponseMessage" class="mt-3"></div>
                                    </div>
                                </div>

                                <!-- Categories Selection Card -->
                                <div class="card mb-3">
                                    <div class="card-header py-3 d-flex justify-content-between bg-transparent border-bottom-0">
                                        <h6 class="mb-0 fw-bold">Categories</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <!-- Categories List (Single Selection) -->
                                            <div class="flex-column" style="width: 48%">
                                                <select id="categorySelect" size="10" class="ms w-100" style="font-size: 16px; padding: 10px" required>
                                                    <!-- Categories with subcategories will be populated here -->
                                                </select>
                                            </div>

                                            <!-- Selected Category List -->
                                            <div class="flex-column" style="width: 48%">
                                                <h6 class="fw-bold">Selected Category</h6>
                                                <ul id="selectedCategoriesList" style="list-style-type: none; padding: 0">
                                                    <!-- Selected category will be added here dynamically -->
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Video Upload Card -->
                                <div class="card mb-3">
                                    <div class="card-header py-3 d-flex justify-content-between bg-transparent border-bottom-0">
                                        <h6 class="mb-0 fw-bold">Video Upload</h6>
                                    </div>
                                    <div class="card-body">
                                        <form id="videoUploadForm">
                                            <div class="row g-3 align-items-center">
                                                <div class="col-md-12">
                                                    <label class="form-label">Product Video Upload</label>
                                                    <small class="d-block text-muted mb-2">
                                                        Only one video is allowed. Maximum size: 50MB.
                                                    </small>
                                                    <input type="file" id="videoInput" class="form-control" accept="video/*" />
                                                    <small id="errorText" class="text-danger mt-1" style="display: none">
                                                        Video size exceeds the 50MB limit. Please choose a smaller file.
                                                    </small>
                                                </div>
                                                <div class="col-md-12 mt-3" id="videoPreviewContainer" style="display: none">
                                                    <video id="videoPreview" controls style="width: 100%; max-height: 400px"></video>
                                                    <button type="button" id="deleteVideoButton" class="btn btn-danger mt-2">
                                                        Delete Video
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>

                                <!-- Images Upload Card -->
                                <div class="card mb-3">
                                    <div class="card-header py-3 d-flex justify-content-between bg-transparent border-bottom-0">
                                        <h6 class="mb-0 fw-bold">Images</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3 align-items-center">
                                            <div class="col-md-12">
                                                <label class="form-label">Product Images Upload</label>
                                                <small class="d-block text-muted mb-2">
                                                    Only portrait or square images, 2MB max and 2000px max-height.
                                                </small>
                                                <input type="file" id="image-uploader" class="form-control" accept="image/*" multiple />
                                                <div id="uploaded-images" class="mt-3 d-flex flex-wrap gap-2"></div>
                                                <div id="file-limit-warning" class="text-danger mt-2" style="display: none">
                                                    You can only upload a maximum of 5 images.
                                                </div>
                                                <div id="file-size-warning" class="text-danger mt-2" style="display: none">
                                                    Image size must not exceed 2MB.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Row end  -->
                    </div>
                </div>
            </form>

            <!-- Modal Custom Settings-->
            <div id="modal"></div>
        </div>
    </div>

    <!-- Load Components -->
    <script>
        /**
         * Loads a component into the specified selector.
         * @param {string} selector - The CSS selector where the component will be loaded.
         * @param {string} url - The URL of the component to load.
         * @returns {Promise} - Resolves when the component is loaded.
         */
        function loadComponent(selector, url) {
            return fetch(url)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error(`Failed to load ${url}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then((data) => {
                    const element = document.querySelector(selector);
                    if (element) {
                        element.innerHTML = data;
                        console.log(`Loaded ${url} into ${selector}`);
                    } else {
                        console.warn(`Selector ${selector} not found`);
                    }
                })
                .catch((error) => {
                    console.error(`Error loading ${url}:`, error);
                });
        }

        // Load components sequentially
        Promise.all([
            loadComponent("#sidebar", "sidebar.html"),
            loadComponent("#header", "header.html"),
            loadComponent("#modal", "modal.html"),
        ])
            .then(() => {
                // Initialize UserProfileManager after components are loaded
                const userProfileManager = new UserProfileManager();
                userProfileManager.initialize().catch((error) => {
                    console.error("Failed to initialize UserProfileManager:", error);
                });
            })
            .catch((error) => {
                console.error("Error loading components:", error);
            });
    </script>

    <!-- Jquery Core Js -->
    <script src="assets/bundles/libscripts.bundle.js"></script>

    <!-- Jquery Plugin -->
    <script src="assets/plugin/multi-select/js/jquery.multi-select.js"></script>
    <script src="assets/plugin/bootstrap-tagsinput/bootstrap-tagsinput.js"></script>

    <script>
        "use strict";

        // Utility function to get product ID from URL
        function getProductIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get("productId");
        }

        let originalMaterials = [];
        let materialsToDelete = [];
        let currentMaterials = [];
        let hasMaterials = false; // Flag to determine if product has materials
        let selectedImageFiles = [];
        let materialsList = []; // List of materials from API

        // Arrays to store existing resource IDs
        let existingImageIDs = [];
        let existingVideoIDs = [];
        let existingImageURLs = [];
        let existingVideoURLs = [];

        document.addEventListener("DOMContentLoaded", function () {
            initializePage();
        });

        async function initializePage() {
            const authToken = sessionStorage.getItem("authToken");
            if (!authToken) {
                alert("You are not authenticated. Please log in first.");
                window.location.href = "login.html"; // Redirect to your login page
                return;
            }

            const productId = getProductIdFromURL();
            console.log("Product ID:", productId);

            initializeCategorySelection();
            initializeImageUploader();
            initializeVideoUploader();
            initializeFormSubmission();

            await fetchAndPopulateCategories();
            await fetchMaterialsList();

            if (productId) {
                await fetchAndPopulateProductData(productId);
                await fetchAndDisplayMaterials(productId);
                initializeMaterialsButtons(productId, authToken);
            }
        }

        // ---------------------------- Fetch Categories ----------------------------
        async function fetchAndPopulateCategories() {
            try {
                const response = await fetch(
                    "http://localhost:5000/api/categories/subcategories",
                    {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${sessionStorage.getItem("authToken")}`,
                        },
                    }
                );

                const data = await response.json();

                if (response.ok && Array.isArray(data)) {
                    const categorySelect = document.getElementById("categorySelect");

                    categorySelect.innerHTML =
                        '<option value="" disabled>Select a Subcategory</option>';

                    data.forEach((category) => {
                        if (category.SubCategory && category.SubCategory.length > 0) {
                            const optgroup = document.createElement("optgroup");
                            optgroup.label = category.Name;

                            category.SubCategory.forEach((subCategory) => {
                                const option = document.createElement("option");
                                option.value = subCategory.SubCategoryID;
                                option.textContent = subCategory.Name;
                                optgroup.appendChild(option);
                            });

                            categorySelect.appendChild(optgroup);
                        }
                    });
                } else {
                    console.error(
                        "Error fetching categories:",
                        data.message || "Unknown error"
                    );
                }
            } catch (error) {
                console.error("Error fetching categories:", error);
            }
        }

        // ---------------------------- Fetch Materials List ----------------------------
        async function fetchMaterialsList() {
            try {
                const response = await fetch(
                    "http://localhost:5000/material/material",
                    {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${sessionStorage.getItem("authToken")}`,
                        },
                    }
                );

                const data = await response.json();

                if (response.ok && Array.isArray(data)) {
                    materialsList = data;
                } else {
                    console.error(
                        "Error fetching materials list:",
                        data.message || "Unknown error"
                    );
                }
            } catch (error) {
                console.error("Error fetching materials list:", error);
            }
        }

        // ---------------------------- Category Selection ----------------------------
        function initializeCategorySelection() {
            const categorySelect = document.getElementById("categorySelect");
            const selectedCategoriesList = document.getElementById(
                "selectedCategoriesList"
            );

            categorySelect.addEventListener("dblclick", function (event) {
                const selectedOption = event.target;

                if (selectedOption.tagName === "OPTION" && !selectedOption.disabled) {
                    // Clear existing selection
                    selectedCategoriesList.innerHTML = "";

                    const listItem = document.createElement("li");
                    listItem.textContent = selectedOption.textContent;
                    listItem.setAttribute("data-value", selectedOption.value);
                    selectedCategoriesList.appendChild(listItem);
                    selectedOption.disabled = true;
                }
            });

            selectedCategoriesList.addEventListener("click", function (event) {
                const clickedItem = event.target;

                if (clickedItem.tagName === "LI") {
                    const value = clickedItem.getAttribute("data-value");
                    clickedItem.remove();
                    const option = categorySelect.querySelector(
                        `option[value="${value}"]`
                    );
                    if (option) option.disabled = false;
                }
            });
        }

        // ---------------------------- Image Uploader ----------------------------
        function initializeImageUploader() {
            const imageUploader = document.getElementById("image-uploader");
            const uploadedImagesContainer =
                document.getElementById("uploaded-images");
            const fileLimitWarning = document.getElementById("file-limit-warning");
            const fileSizeWarning = document.getElementById("file-size-warning");
            let uploadedImagesCount = uploadedImagesContainer.children.length;

            imageUploader.addEventListener("change", function (event) {
                const files = event.target.files;
                let validFiles = [];

                Array.from(files).forEach((file) => {
                    if (file.size > 2 * 1024 * 1024) {
                        fileSizeWarning.style.display = "block";
                    } else {
                        fileSizeWarning.style.display = "none";
                        validFiles.push(file);
                    }
                });

                if (uploadedImagesCount + validFiles.length > 5) {
                    fileLimitWarning.style.display = "block";
                    event.target.value = "";
                    return;
                }

                fileLimitWarning.style.display = "none";

                validFiles.forEach((file) => {
                    uploadedImagesCount++;
                    selectedImageFiles.push(file);

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const imgElement = document.createElement("img");
                        imgElement.src = e.target.result;
                        imgElement.alt = file.name;

                        const removeButton = document.createElement("button");
                        removeButton.innerHTML = "&times;";
                        removeButton.title = "Remove Image";
                        removeButton.setAttribute("data-resource-id", ""); // New images don't have ResourceID yet

                        const wrapper = document.createElement("div");
                        wrapper.className = "resource-container";
                        wrapper.appendChild(imgElement);
                        wrapper.appendChild(removeButton);

                        uploadedImagesContainer.appendChild(wrapper);

                        removeButton.addEventListener("click", () => {
                            wrapper.remove();
                            uploadedImagesCount--;
                            selectedImageFiles = selectedImageFiles.filter(
                                (f) => f !== file
                            );
                            fileLimitWarning.style.display = "none";
                        });
                    };
                    reader.readAsDataURL(file);
                });

                event.target.value = "";
            });

            window.getSelectedImageFiles = function () {
                return selectedImageFiles;
            };
        }

        // ---------------------------- Video Uploader ----------------------------
        function initializeVideoUploader() {
            const videoInput = document.getElementById("videoInput");
            const videoPreviewContainer = document.getElementById(
                "videoPreviewContainer"
            );
            const videoPreview = document.getElementById("videoPreview");
            const errorText = document.getElementById("errorText");
            const deleteVideoButton = document.getElementById("deleteVideoButton");

            videoInput.addEventListener("change", function (event) {
                const file = event.target.files[0];
                if (!file) return;

                if (file.size > 50 * 1024 * 1024) {
                    errorText.style.display = "block";
                    this.value = "";
                    return;
                }

                errorText.style.display = "none";
                const fileURL = URL.createObjectURL(file);
                displayVideo(fileURL);
            });

            deleteVideoButton.addEventListener("click", function () {
                videoInput.value = "";
                videoPreview.src = "";
                videoPreviewContainer.style.display = "none";
                errorText.style.display = "none";
                existingVideoIDs = []; // Remove existing video ID if any
            });
        }

        function displayVideo(videoUrl) {
            const videoPreview = document.getElementById("videoPreview");
            const videoPreviewContainer = document.getElementById(
                "videoPreviewContainer"
            );
            videoPreview.src = videoUrl;
            videoPreviewContainer.style.display = "block";
            existingVideoIDs = []; // Reset existingVideoIDs since new video is uploaded
        }

        // ---------------------------- Display Existing Image ----------------------------
        function displayExistingImage(resource) {
            const uploadedImagesContainer =
                document.getElementById("uploaded-images");
            const fileLimitWarning = document.getElementById("file-limit-warning");
            let uploadedImagesCount = uploadedImagesContainer.children.length;

            if (uploadedImagesCount >= 5) {
                fileLimitWarning.style.display = "block";
                return;
            }

            existingImageIDs.push(resource.ResourceID);
            existingImageURLs.push(resource.filePath);

            const imgElement = document.createElement("img");
            imgElement.src = `http://localhost:5000/${resource.filePath.replace(
                /\\/g,
                "/"
            )}`;
            imgElement.alt = `Image ${resource.ResourceID}`;

            const removeButton = document.createElement("button");
            removeButton.innerHTML = "&times;";
            removeButton.title = "Remove Image";
            removeButton.setAttribute("data-resource-id", resource.ResourceID);

            const wrapper = document.createElement("div");
            wrapper.className = "resource-container";
            wrapper.appendChild(imgElement);
            wrapper.appendChild(removeButton);

            uploadedImagesContainer.appendChild(wrapper);

            removeButton.addEventListener("click", () => {
                wrapper.remove();
                uploadedImagesCount--;
                existingImageIDs = existingImageIDs.filter(
                    (id) => id !== resource.ResourceID
                );
                existingImageURLs = existingImageURLs.filter(
                    (url) => url !== resource.filePath
                );
                fileLimitWarning.style.display = "none";
            });
        }

        // ---------------------------- Display Existing Video ----------------------------
        function displayExistingVideo(resource) {
            const videoPreviewContainer = document.getElementById(
                "videoPreviewContainer"
            );
            const videoPreview = document.getElementById("videoPreview");

            existingVideoIDs.push(resource.ResourceID);
            existingVideoURLs.push(resource.filePath);

            videoPreview.src = `http://localhost:5000/${resource.filePath.replace(
                /\\/g,
                "/"
            )}`;
            videoPreviewContainer.style.display = "block";
        }

        // ---------------------------- Customizations ----------------------------
        function displayCustomizations(customizations) {
            const customizationContainer = document.getElementById(
                "customizationContainer"
            );

            if (!customizationContainer) {
                console.error("Customization container not found in the HTML.");
                return;
            }

            customizationContainer.innerHTML = "";

            if (!customizations || customizations.length === 0) {
                customizationContainer.innerHTML =
                    "<p>No customizations assigned.</p>";
                return;
            }

            customizations.forEach((customization) => {
                const customizationCard = document.createElement("div");
                customizationCard.className = "card mb-3";
                customizationCard.setAttribute(
                    "data-customization-id",
                    customization.CustomizationID
                );

                const customizationHeader = document.createElement("div");
                customizationHeader.className =
                    "card-header py-3 d-flex justify-content-between align-items-center bg-transparent border-bottom-0";
                customizationHeader.innerHTML = `
                    <h6 class="mb-0 fw-bold">${customization.option.name} (${customization.option.type})</h6>
                    <button type="button" class="btn btn-danger btn-sm delete-customization">Delete</button>
                `;

                const customizationBody = document.createElement("div");
                customizationBody.className = "card-body";
                const optionsList = document.createElement("ul");
                optionsList.className = "list-group list-group-flush";

                customization.option.optionValues.forEach((optionValue) => {
                    const listItem = document.createElement("li");
                    listItem.className =
                        "list-group-item d-flex justify-content-between align-items-center";
                    listItem.textContent = optionValue.name;
                    if (optionValue.value) {
                        listItem.textContent += ` - ${optionValue.value}`;
                    }
                    optionsList.appendChild(listItem);
                });

                customizationBody.appendChild(optionsList);
                customizationCard.appendChild(customizationHeader);
                customizationCard.appendChild(customizationBody);
                customizationContainer.appendChild(customizationCard);
            });
        }

        document.addEventListener("click", async function (event) {
            if (
                event.target &&
                event.target.classList.contains("delete-customization")
            ) {
                const customizationCard = event.target.closest(".card");
                const customizationId = customizationCard.getAttribute(
                    "data-customization-id"
                );
                const productId = getProductIdFromURL();

                if (!customizationId || !productId) {
                    alert("Customization ID or Product ID is missing.");
                    return;
                }

                if (confirm("Are you sure you want to delete this customization?")) {
                    const response = await fetch(
                        `http://localhost:5000/api/customization/product`,
                        {
                            method: "DELETE",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${sessionStorage.getItem(
                                    "authToken"
                                )}`,
                            },
                            body: JSON.stringify({
                                customizationId: parseInt(customizationId),
                                productIds: [parseInt(productId)],
                            }),
                        }
                    );

                    if (response.status == 200) {
                        const data = await response.json();
                        if (data.success) {
                            customizationCard.remove();
                            alert("Customization deleted successfully.");
                        } else {
                            console.error(
                                "Error deleting customization:",
                                data.message || "Unknown error"
                            );
                            alert("An error occurred while deleting the customization.");
                        }
                    } else {
                        console.error(
                            "Error deleting customization:",
                            response.statusText
                        );
                        alert("An error occurred while deleting the customization.");
                    }
                }
            }
        });

        // ---------------------------- Materials Logic ----------------------------
        async function fetchAndDisplayMaterials(productId) {
            const authToken = sessionStorage.getItem("authToken");
            try {
                const response = await fetch(
                    `http://localhost:5000/material/product/${productId}`,
                    {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                            ...(authToken ? { Authorization: `Bearer ${authToken}` } : {}),
                        },
                    }
                );

                if (!response.ok) {
                    // If no materials (404 or empty), then no materials assigned
                    hasMaterials = false;
                    originalMaterials = [];
                    currentMaterials = [];
                    return;
                }

                const materialsData = await response.json();
                if (Array.isArray(materialsData) && materialsData.length > 0) {
                    hasMaterials = true;
                    originalMaterials = materialsData.map((m) => ({ ...m }));
                    currentMaterials = materialsData.map((m) => ({ ...m }));
                } else {
                    hasMaterials = false;
                    originalMaterials = [];
                    currentMaterials = [];
                }

                renderMaterials();
            } catch (error) {
                console.error("Error fetching materials:", error);
                hasMaterials = false;
                originalMaterials = [];
                currentMaterials = [];
            }
        }

        function renderMaterials() {
            const materialsContainer =
                document.getElementById("materialsContainer");
            materialsContainer.innerHTML = "";
            currentMaterials.forEach((mat) => {
                const materialItem = document.createElement("div");
                materialItem.className = "material-item row";

                const materialName =
                    materialsList.find((m) => m.MaterialID === mat.MaterialID)?.Name ||
                    "";

                materialItem.innerHTML = `
                    <div class="col-md-5">
                        <label class="form-label">Material Name</label>
                        <select class="form-control material-name" required>
                            <option value="" disabled>Select Material</option>
                            ${materialsList
                                .map(
                                    (material) => `
                                <option value="${material.MaterialID}" ${
                                        material.MaterialID === mat.MaterialID ? "selected" : ""
                                    }>${material.Name}</option>
                            `
                                )
                                .join("")}
                        </select>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">Percentage</label>
                        <input type="number" class="form-control material-percentage" value="${mat.percentage}" placeholder="Enter Percentage" min="0" max="100" required>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-danger remove-material-btn">Remove</button>
                    </div>
                `;

                materialsContainer.appendChild(materialItem);
            });
        }

        function createMaterialItem() {
            const materialItem = document.createElement("div");
            materialItem.className = "material-item row";

            materialItem.innerHTML = `
                <div class="col-md-5">
                    <label class="form-label">Material Name</label>
                    <select class="form-control material-name" required>
                        <option value="" disabled selected>Select Material</option>
                        ${materialsList
                            .map(
                                (material) => `
                            <option value="${material.MaterialID}">${material.Name}</option>
                        `
                            )
                            .join("")}
                    </select>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Percentage</label>
                    <input type="number" class="form-control material-percentage" placeholder="Enter Percentage" min="0" max="100" required>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-danger remove-material-btn">Remove</button>
                </div>
            `;

            return materialItem;
        }

        function initializeMaterialsButtons(productId, authToken) {
            const addMaterialBtn = document.getElementById("addMaterialBtn");
            const updateMaterialsBtn =
                document.getElementById("updateMaterialsBtn");
            const materialsContainer =
                document.getElementById("materialsContainer");
            const materialsResponseMessage = document.getElementById(
                "materialsResponseMessage"
            );

            addMaterialBtn.addEventListener("click", function () {
                materialsContainer.appendChild(createMaterialItem());
            });

            materialsContainer.addEventListener("click", function (e) {
                if (e.target && e.target.classList.contains("remove-material-btn")) {
                    const item = e.target.closest(".material-item");
                    const materialSelect = item.querySelector(".material-name");
                    const materialId = parseInt(materialSelect.value, 10);
                    const orig = originalMaterials.find(
                        (m) => m.MaterialID === materialId
                    );
                    if (orig) {
                        materialsToDelete.push(orig.Name);
                    }
                    item.remove();
                }
            });

            updateMaterialsBtn.addEventListener("click", async function () {
                const materialItems = document.querySelectorAll(".material-item");
                const newMaterials = [];
                let totalPercentage = 0;
                let valid = true;
                const materialNamesSet = new Set();

                materialItems.forEach((item) => {
                    const materialSelect = item.querySelector(".material-name");
                    const materialId = parseInt(materialSelect.value, 10);
                    const percentage = parseInt(
                        item.querySelector(".material-percentage").value,
                        10
                    );

                    const materialName = materialsList.find(
                        (m) => m.MaterialID === materialId
                    )?.Name;

                    if (
                        !materialName ||
                        isNaN(percentage) ||
                        percentage < 0 ||
                        percentage > 100
                    ) {
                        valid = false;
                        return;
                    }

                    if (materialNamesSet.has(materialName)) {
                        // Duplicate material name not allowed
                        valid = false;
                        return;
                    }

                    materialNamesSet.add(materialName);
                    totalPercentage += percentage;
                    newMaterials.push({ name: materialName, percentage });
                });

                if (!valid) {
                    alert(
                        "Please ensure all materials are selected and percentages are valid with no duplicates."
                    );
                    return;
                }

                if (totalPercentage !== 100) {
                    alert(
                        "Total percentage of materials must equal 100%. Currently, it is " +
                            totalPercentage +
                            "%."
                    );
                    return;
                }

                if (!hasMaterials && newMaterials.length > 0) {
                    // Assign materials via POST /material/product/assign
                    try {
                        const assignResponse = await fetch(
                            "http://localhost:5000/material/product/assign",
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${authToken}`,
                                },
                                body: JSON.stringify({
                                    ProductID: parseInt(productId),
                                    Materials: newMaterials,
                                }),
                            }
                        );

                        const assignData = await assignResponse.json();
                        if (assignResponse.ok && assignData.success) {
                            materialsResponseMessage.innerHTML = `<div class="alert alert-success">${
                                assignData.message || "Materials assigned successfully!"
                            }</div>`;
                            originalMaterials = [...newMaterials];
                            currentMaterials = [...newMaterials];
                            hasMaterials = true;
                            materialsToDelete = [];
                        } else {
                            materialsResponseMessage.innerHTML = `<div class="alert alert-danger">${
                                assignData.message || "Failed to assign materials."
                            }</div>`;
                        }
                    } catch (error) {
                        console.error("Error assigning materials:", error);
                        materialsResponseMessage.innerHTML = `<div class="alert alert-danger">An error occurred while assigning materials. Please try again.</div>`;
                    }
                } else if (hasMaterials) {
                    // Materials were previously assigned
                    // Handle deletions first
                    let deletionFailed = false;
                    if (materialsToDelete.length > 0) {
                        try {
                            const deleteResponse = await fetch(
                                "http://localhost:5000/material/product/delete",
                                {
                                    method: "DELETE",
                                    headers: {
                                        "Content-Type": "application/json",
                                        Authorization: `Bearer ${authToken}`,
                                    },
                                    body: JSON.stringify({
                                        ProductID: parseInt(productId),
                                        MaterialNames: materialsToDelete,
                                    }),
                                }
                            );

                            const deleteData = await deleteResponse.json();
                            if (!deleteResponse.ok || !deleteData.success) {
                                materialsResponseMessage.innerHTML = `<div class="alert alert-danger">${
                                    deleteData.message || "Failed to remove some materials."
                                }</div>`;
                                deletionFailed = true;
                            } else {
                                // Update originalMaterials and currentMaterials
                                originalMaterials = originalMaterials.filter(
                                    (m) => !materialsToDelete.includes(m.name)
                                );
                                currentMaterials = currentMaterials.filter(
                                    (m) => !materialsToDelete.includes(m.name)
                                );
                                materialsToDelete = [];
                            }
                        } catch (error) {
                            console.error("Error deleting materials:", error);
                            materialsResponseMessage.innerHTML = `<div class="alert alert-danger">An error occurred while deleting materials. Please try again.</div>`;
                            deletionFailed = true;
                        }
                    }

                    if (deletionFailed) {
                        return;
                    }

                    // Now update using PUT /material/product/update
                    try {
                        const updateResponse = await fetch(
                            "http://localhost:5000/material/product/update",
                            {
                                method: "PUT",
                                headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${authToken}`,
                                },
                                body: JSON.stringify({
                                    ProductID: parseInt(productId),
                                    Materials: newMaterials,
                                }),
                            }
                        );

                        const updateData = await updateResponse.json();
                        if (updateResponse.ok && updateData.success) {
                            materialsResponseMessage.innerHTML = `<div class="alert alert-success">${
                                updateData.message || "Materials updated successfully!"
                            }</div>`;
                            originalMaterials = [...newMaterials];
                            currentMaterials = [...newMaterials];
                        } else {
                            materialsResponseMessage.innerHTML = `<div class="alert alert-danger">${
                                updateData.message || "Failed to update materials."
                            }</div>`;
                        }
                    } catch (error) {
                        console.error("Error updating materials:", error);
                        materialsResponseMessage.innerHTML = `<div class="alert alert-danger">An error occurred while updating materials. Please try again.</div>`;
                    }
                }

                setTimeout(function () {
                    materialsResponseMessage.innerHTML = "";
                }, 5000);
            });
        }

        // ---------------------------- Form Submission ----------------------------
        function initializeFormSubmission() {
            document
                .getElementById("EditProductForm")
                .addEventListener("submit", function (e) {
                    e.preventDefault();
                    const productId = getProductIdFromURL();

                    if (!productId) {
                        alert("Product ID is missing from the URL.");
                        return;
                    }

                    const formData = new FormData();
                    formData.append(
                        "Name",
                        document.getElementById("productName").value
                    );
                    formData.append("Price", document.getElementById("price").value);
                    formData.append(
                        "Quantity",
                        document.getElementById("quantity").value
                    );
                    formData.append(
                        "Description",
                        document.getElementById("description").value
                    );
                    formData.append(
                        "SubCategoryID",
                        document.getElementById("categorySelect").value
                    );
                    formData.append(
                        "BrandID",
                        document.getElementById("brandSelect").value
                    );

                    // Append existing resource IDs to retain
                    formData.append(
                        "existingImageIDs",
                        JSON.stringify(existingImageIDs)
                    );
                    formData.append(
                        "existingVideoIDs",
                        JSON.stringify(existingVideoIDs)
                    );

                    // Append new images
                    const selectedImages = window.getSelectedImageFiles
                        ? window.getSelectedImageFiles()
                        : [];
                    selectedImages.forEach((file, index) => {
                        formData.append("images", file, file.name);
                        console.log(`Appending new image ${index + 1}:`, file.name);
                    });

                    // Append new video
                    const videoInput = document.getElementById("videoInput");
                    const video = videoInput.files[0];
                    if (video) {
                        formData.append("videos", video, video.name);
                        console.log("Appending new video:", video.name);
                    }

                    // Debug: Log FormData keys and values
                    console.log("FormData contents:");
                    for (let pair of formData.entries()) {
                        if (pair[1] instanceof File) {
                            console.log(
                                `${pair[0]}: ${pair[1].name} (${pair[1].type}, ${pair[1].size} bytes)`
                            );
                        } else {
                            console.log(`${pair[0]}: ${pair[1]}`);
                        }
                    }

                    fetch(`http://localhost:5000/api/product/${productId}`, {
                        method: "PUT",
                        headers: {
                            // Do NOT set 'Content-Type' when sending FormData
                            Authorization: `Bearer ${sessionStorage.getItem("authToken")}`,
                        },
                        body: formData,
                    })
                        .then((response) => {
                            // Debug: Log response headers
                            console.log("Response Headers:", [
                                ...response.headers.entries(),
                            ]);
                            return response.json();
                        })
                        .then((response) => {
                            const responseMessage =
                                document.getElementById("responseMessage");
                            if (response.success) {
                                responseMessage.innerHTML =
                                    '<div class="alert alert-success">Product updated successfully!</div>';
                                // Optionally, reload the page or redirect
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1500);
                            } else {
                                responseMessage.innerHTML = `<div class="alert alert-danger">${response.message}</div>`;
                            }

                            // Debug: Log server response
                            console.log("Server Response:", response);

                            setTimeout(() => {
                                responseMessage.innerHTML = "";
                            }, 3000);
                        })
                        .catch((error) => {
                            console.error("Error updating product:", error);
                            const responseMessage =
                                document.getElementById("responseMessage");
                            responseMessage.innerHTML =
                                '<div class="alert alert-danger">Failed to update product.</div>';
                        });
                });
        }

        // ---------------------------- Fetch and Populate Product Data ----------------------------
        async function fetchAndPopulateProductData(productId) {
            try {
                const response = await fetch(
                    `http://localhost:5000/api/getProduct/${productId}`,
                    {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${sessionStorage.getItem("authToken")}`,
                        },
                    }
                );

                const productData = await response.json();

                if (response.ok && productData) {
                    document.getElementById("productName").value =
                        productData.Name || "";
                    document.getElementById("price").value = productData.Price || "";
                    document.getElementById("quantity").value =
                        productData.Quantity || "";
                    document.getElementById("description").value =
                        productData.Description || "";

                    // BrandID must be set in brandSelect
                    if (productData.Brand && productData.Brand.BrandID) {
                        document.getElementById("brandSelect").value =
                            productData.Brand.BrandID;
                    }

                    // Category selection
                    if (
                        productData.SubCategory &&
                        productData.SubCategory.SubCategoryID
                    ) {
                        const subCategoryId = productData.SubCategory.SubCategoryID;
                        const subCategoryName =
                            productData.SubCategory.Name || "Unnamed Category";
                        const categorySelect = document.getElementById("categorySelect");
                        const optionToSelect = categorySelect.querySelector(
                            `option[value="${subCategoryId}"]`
                        );
                        if (optionToSelect) {
                            optionToSelect.selected = true;
                            optionToSelect.disabled = true;
                            const selectedCategoriesList = document.getElementById(
                                "selectedCategoriesList"
                            );
                            selectedCategoriesList.innerHTML = "";
                            const listItem = document.createElement("li");
                            listItem.textContent = subCategoryName;
                            listItem.setAttribute("data-value", subCategoryId);
                            selectedCategoriesList.appendChild(listItem);
                        } else {
                            console.error(
                                "SubCategory option not found in the select element."
                            );
                        }
                    }

                    // Images
                    const imageResources = productData.Resource.filter((resource) =>
                        resource.fileType.startsWith("image/")
                    );
                    imageResources.forEach((image) => displayExistingImage(image));

                    // Videos
                    const videoResources = productData.Resource.filter((resource) =>
                        resource.fileType.startsWith("video/")
                    );
                    if (videoResources.length > 0) {
                        videoResources.forEach((video) => displayExistingVideo(video));
                    }

                    // Customizations
                    displayCustomizations(productData.Customization);
                } else {
                    console.error(
                        "Error fetching product data:",
                        productData.message || "Unknown error"
                    );
                }
            } catch (error) {
                console.error("Error fetching product data:", error);
            }
        }
    </script>
    <!-- Include this script after loading all components -->
    <script>
        class UserProfileManager {
            constructor() {
                this.authToken = sessionStorage.getItem("authToken");
                this.defaultImage = "assets/images/profile_av.svg";
                this.apiBaseUrl = "http://localhost:5000"; // Update if needed
                this.userDataKey = "userData"; // Key for storing user data in sessionStorage
            }

            /**
             * Initializes the UserProfileManager.
             */
            async initialize() {
                console.log("Initializing UserProfileManager");
                if (!this.authToken) {
                    console.log("No authToken found, redirecting to signin");
                    this.handleSignout();
                    return;
                }

                if (this.isTokenExpired(this.authToken)) {
                    console.log("Auth token is expired, redirecting to signin");
                    this.handleSignout();
                    return;
                }

                try {
                    let userData = this.getStoredUserData();

                    if (!userData) {
                        console.log("No user data in sessionStorage, fetching from API");
                        const userId = this.getUserIdFromToken(this.authToken);
                        userData = await this.fetchUserData(userId);
                        this.storeUserData(userData);
                    } else {
                        console.log("User data retrieved from sessionStorage");
                    }

                    this.updateProfile(userData);
                    console.log("UserProfileManager initialized successfully");
                } catch (error) {
                    console.error("Initialization error:", error);
                    this.setDefaultProfileValues();
                }
            }

            /**
             * Checks if the JWT token is expired.
             * @param {string} token - The JWT token.
             * @returns {boolean} True if expired, false otherwise.
             */
            isTokenExpired(token) {
                try {
                    const payload = JSON.parse(atob(token.split(".")[1]));
                    const currentTime = Math.floor(Date.now() / 1000);
                    return payload.exp && payload.exp < currentTime;
                } catch (error) {
                    console.error("Error checking token expiry:", error);
                    return true; // Treat as expired if unable to parse
                }
            }

            /**
             * Extracts the userId from the JWT token.
             * @param {string} token - The JWT token.
             * @returns {string} The userId.
             */
            getUserIdFromToken(token) {
                try {
                    const payload = JSON.parse(atob(token.split(".")[1]));
                    return payload.payload.userId;
                } catch (error) {
                    console.error("Error extracting userId from token:", error);
                    throw new Error("Invalid token");
                }
            }

            /**
             * Fetches user data from the API.
             * @param {string} userId - The user ID.
             * @returns {Object} The user data.
             */
            async fetchUserData(userId) {
                const apiUrl = `${this.apiBaseUrl}/api/getusers/${userId}`;
                try {
                    const response = await fetch(apiUrl, {
                        method: "GET",
                        headers: {
                            Authorization: `Bearer ${this.authToken}`,
                            "Content-Type": "application/json",
                        },
                    });

                    if (!response.ok) {
                        throw new Error(
                            `API request failed with status ${response.status}`
                        );
                    }

                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error("Error fetching user data:", error);
                    throw error;
                }
            }

            /**
             * Stores user data in sessionStorage.
             * @param {Object} userData - The user data to store.
             */
            storeUserData(userData) {
                try {
                    sessionStorage.setItem(this.userDataKey, JSON.stringify(userData));
                    sessionStorage.setItem("auth", this.authToken); // Aligning with sidebar.js
                    sessionStorage.setItem(
                        "email",
                        userData.email || "user@example.com"
                    ); // Aligning with sidebar.js
                    console.log("User data stored in sessionStorage");
                } catch (error) {
                    console.error("Error storing user data in sessionStorage:", error);
                }
            }

            /**
             * Retrieves user data from sessionStorage.
             * @returns {Object|null} The user data or null if not found.
             */
            getStoredUserData() {
                try {
                    const data = sessionStorage.getItem(this.userDataKey);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error(
                        "Error retrieving user data from sessionStorage:",
                        error
                    );
                    return null;
                }
            }

            /**
             * Updates the profile information in the DOM.
             * @param {Object} userData - The user data from the API or sessionStorage.
             */
            updateProfile(userData) {
                if (!userData) {
                    console.warn("No user data provided");
                    this.setDefaultProfileValues();
                    return;
                }

                const { Username, UserProfilePicture } = userData;

                // Update username
                const profileUserName = document.getElementById("profileUserName");
                const profileUserNameSmall = document.getElementById(
                    "profileUserNameSmall"
                );
                if (profileUserName) {
                    profileUserName.textContent = Username || "User";
                } else {
                    console.warn("Element with id profileUserName not found");
                }

                if (profileUserNameSmall) {
                    profileUserNameSmall.textContent = Username || "User";
                } else {
                    console.warn("Element with id profileUserNameSmall not found");
                }

                // Update email and role if needed (from userData or token)
                const profileEmail = document.getElementById("profileEmail");
                const profileRole = document.getElementById("profileRole");
                if (profileEmail) {
                    profileEmail.textContent = userData.email || "user@example.com";
                } else {
                    console.warn("Element with id profileEmail not found");
                }

                if (profileRole) {
                    profileRole.textContent = `${userData.role || "User"} Profile`;
                } else {
                    console.warn("Element with id profileRole not found");
                }

                // Update profile images
                this.updateProfileImages(UserProfilePicture);
            }

            /**
             * Updates the profile images in the DOM.
             * @param {Object} profilePicture - The user's profile picture information.
             */
            updateProfileImages(profilePicture) {
                if (!profilePicture || !profilePicture.filePath) {
                    console.log(
                        "No profile picture information available. Using default image."
                    );
                    this.setDefaultProfileImages();
                    return;
                }

                // Normalize filePath to use forward slashes
                const normalizedFilePath = profilePicture.filePath.replace(
                    /\\/g,
                    "/"
                );

                // Construct the full URL for the profile image
                const profileImageUrl = `${this.apiBaseUrl}/${normalizedFilePath}`;

                console.log(`Loading profile image from: ${profileImageUrl}`);

                const imageElements = ["profileImage", "profileImageSmall"];

                imageElements.forEach((elementId) => {
                    const imgElement = document.getElementById(elementId);
                    if (imgElement) {
                        imgElement.onerror = () => {
                            console.warn(
                                `Failed to load image: ${profileImageUrl}. Using default image.`
                            );
                            imgElement.src = this.defaultImage;
                            imgElement.onerror = null; // Prevent infinite loop if default image also fails
                        };
                        imgElement.src = profileImageUrl;
                    } else {
                        console.warn(`Image element with id ${elementId} not found`);
                    }
                });
            }

            /**
             * Sets default profile values when user data is unavailable.
             */
            setDefaultProfileValues() {
                const defaultValues = {
                    userName: "User",
                    email: "user@example.com",
                    role: "User",
                };

                const profileUserName = document.getElementById("profileUserName");
                const profileUserNameSmall = document.getElementById(
                    "profileUserNameSmall"
                );
                const profileEmail = document.getElementById("profileEmail");
                const profileRole = document.getElementById("profileRole");

                if (profileUserName) {
                    profileUserName.textContent = defaultValues.userName;
                }

                if (profileUserNameSmall) {
                    profileUserNameSmall.textContent = defaultValues.userName;
                }

                if (profileEmail) {
                    profileEmail.textContent = defaultValues.email;
                }

                if (profileRole) {
                    profileRole.textContent = `${defaultValues.role} Profile`;
                }

                this.setDefaultProfileImages();
            }

            /**
             * Sets the profile images to the default image.
             */
            setDefaultProfileImages() {
                const imageElements = ["profileImage", "profileImageSmall"];
                imageElements.forEach((elementId) => {
                    const imgElement = document.getElementById(elementId);
                    if (imgElement) {
                        imgElement.src = this.defaultImage;
                    } else {
                        console.warn(`Image element with id ${elementId} not found`);
                    }
                });
            }

            /**
             * Handles the signout process by clearing the auth token and user data, then redirecting to the signin page.
             */
            handleSignout() {
                sessionStorage.removeItem("authToken");
                sessionStorage.removeItem(this.userDataKey); // Clear stored user data
                sessionStorage.removeItem("auth"); // Aligning with sidebar.js
                sessionStorage.removeItem("email"); // Aligning with sidebar.js
                // Remove other session items if necessary
                window.location.href = "auth-signin.html";
            }
        }

        // Initialize when the document is ready
        // (Already handled in the loadComponent Promise chain)
    </script>
    <script src="../js/template.js"></script>
</body>
</html>
